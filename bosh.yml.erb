---
<%
require 'yaml'

[
  'zone', 
  'service_account_email', 
  'network', 
  'subnetwork', 
  'project_id', 
  'ssh_key_path',
].each do |val|
  if ENV[val].nil? || ENV[val].empty?
    raise "Missing environment variable: #{val}"
  end
end

bosh_credentials_path = "#{ENV['privates_dir']}/#{ENV['project_id']}/credentials.yml"
credentials = YAML.load_file(bosh_credentials_path)['credentials']
[
  'nats_password',
  'postgres_password',
  'director_password',
  'agent_password',
  'hm_password',
  'nats_password',
  'mbus_password',
  'admin_username',
  'admin_password',
].each do |val|
  if credentials[val].nil? || credentials[val].empty?
    raise "Missing credential: #{val}"
  end
end

nats_password = credentials['nats_password']
postgres_password = credentials['postgres_password']
director_password = credentials['director_password']
agent_password = credentials['agent_password']
hm_password = credentials['hm_password']
mbus_password = credentials['mbus_password']
admin_username = credentials['admin_username']
admin_password = credentials['admin_password']
%>
name: bosh

releases:
  - name: bosh
    url: https://bosh.io/d/github.com/cloudfoundry/bosh?v=260.3
    sha1: 22c79db2a785efa9cbc32c62b8094500e952e170
  - name: bosh-google-cpi
    url: https://bosh.io/d/github.com/cloudfoundry-incubator/bosh-google-cpi-release?v=25.6.2
    sha1: b4865397d867655fdcc112bc5a7f9a5025cdf311

resource_pools:
  - name: vms
    network: private
    stemcell:
      url: https://bosh.io/d/stemcells/bosh-google-kvm-ubuntu-trusty-go_agent?v=3312.17
      sha1: b788e7b08dccec03515ef3b4a2e2227dc3f98d55
    cloud_properties:
      zone: <%= ENV['zone'] %>
      machine_type: n1-standard-1
      root_disk_size_gb: 40
      root_disk_type: pd-standard
      service_account: <%= ENV['service_account_email'] %>

disk_pools:
  - name: disks
    disk_size: 32_768
    cloud_properties:
      type: pd-standard

networks:
  - name: vip
    type: vip
  - name: private
    type: manual
    subnets:
    - range: 10.0.0.0/29
      gateway: 10.0.0.1
      static: [10.0.0.3-10.0.0.7]
      cloud_properties:
        network_name: <%= ENV['network'] %>
        subnetwork_name: <%= ENV['subnetwork'] %>
        ephemeral_external_ip: false
        tags:
          - bosh-internal
          - no-ip

jobs:
  - name: bosh
    instances: 1

    templates:
      - name: nats
        release: bosh
      - name: postgres
        release: bosh
      - name: powerdns
        release: bosh
      - name: blobstore
        release: bosh
      - name: director
        release: bosh
      - name: health_monitor
        release: bosh
      - name: google_cpi
        release: bosh-google-cpi

    resource_pool: vms
    persistent_disk_pool: disks

    networks:
      - name: private
        static_ips: [10.0.0.6]
        default:
          - dns
          - gateway

    properties:
      nats:
        address: 127.0.0.1
        user: nats
        password: <%= nats_password %>

      postgres: &db
        listen_address: 127.0.0.1
        host: 127.0.0.1
        user: postgres
        password: <%= postgres_password %>
        database: bosh
        adapter: postgres

      dns:
        address: 10.0.0.6
        domain_name: microbosh
        db: *db
        recursor: 169.254.169.254

      blobstore:
        address: 10.0.0.6
        port: 25250
        provider: dav
        director:
          user: director
          password: <%= director_password %>
        agent:
          user: agent
          password: <%= agent_password %>

      director:
        address: 127.0.0.1
        name: micro-google
        db: *db
        cpi_job: google_cpi
        user_management:
          provider: local
          local:
            users:
              - name: <%= admin_username %>
                password: <%= admin_password %>
              - name: hm
                password: <%= hm_password %>
      hm:
        director_account:
          user: hm
          password: <%= hm_password %>
        resurrector_enabled: true

      google: &google_properties
        project: <%= ENV['project_id'] %>

      agent:
        mbus: nats://nats:<%= nats_password %>@10.0.0.6:4222
        ntp: *ntp
        blobstore:
           options:
             endpoint: http://10.0.0.6:25250
             user: agent
             password: <%= agent_password %>

      ntp: &ntp
        - 169.254.169.254

cloud_provider:
  template:
    name: google_cpi
    release: bosh-google-cpi

  ssh_tunnel:
    host: 10.0.0.6
    port: 22
    user: bosh
    private_key: <%= ENV['ssh_key_path'] %>

  mbus: https://mbus:<%= mbus_password %>@10.0.0.6:6868

  properties:
    google: *google_properties
    agent: {mbus: "https://mbus:<%= mbus_password %>@0.0.0.0:6868"}
    blobstore: {provider: local, path: /var/vcap/micro_bosh/data/cache}
    ntp: *ntp
